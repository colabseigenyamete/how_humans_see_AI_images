<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AI画像識別実験</title>
  <script src="https://unpkg.com/jspsych@7.3.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response"></script>
  <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-slider-response"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form"></script>
  <style>
  /* スライダー全体の横幅を100%にする */
  .jspsych-html-slider-response-container .jspsych-slider {
    width: 100% !important;
    margin: 0 auto; /* 中央寄せ */
  }
  </style>
</head>
<body></body>
<script>

var jsPsych = initJsPsych();
var timeline = [];

// === 刺激リスト ===
var stimuli = [
  {stimulus: 'stimuli/sample1.png'},
  {stimulus: 'stimuli/sample2.png'}
];

stimuli.forEach(function(stim){

  // (1) 予告画面
  var duration = jsPsych.randomization.sampleWithoutReplacement(
    [0.25,0.5,0.75,1.0,2.0,3.0,4.0,5.0,6.0,7.0,8.0,9.0,10.0], 1
  )[0];
  
  timeline.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `<p>これから画像を <b>${duration} 秒</b> 表示します。<br>
               AI生成かどうか判断してください。</p>
               <p>スペースキーで開始</p>`,
    choices: [" "],
    data: {trial_type: "instruction", duration: duration, img: stim.stimulus}
  });

  // (2) 画像提示
  timeline.push({
    type: jsPsychImageKeyboardResponse,
    stimulus: stim.stimulus,
    choices: "NO_KEYS",
    trial_duration: duration*1000,
    data: {trial_type: "image_presentation", duration: duration, img: stim.stimulus}
  });

  // (3) 初期スライダー回答
  timeline.push({
    type: jsPsychHtmlSliderResponse,
    stimulus: `<p>この画像はAI生成だと思いますか？</p>`,
    labels: ["完全に人間", "かなり人間", "やや人間", "不明", "ややAI", "かなりAI", "完全にAI"],
    min: 0, max: 6, start: 3, step: 1,
    require_movement: true,
    slider_width: 800,
    data: {trial_type: "initial_slider", img: stim.stimulus, duration: duration}
  });

  // (4) 初期理由
  timeline.push({
    type: jsPsychSurveyHtmlForm,
    preamble: `<p>初期判断の理由を記述してください</p>`,
    html: `<textarea name="reason_initial" rows="5" cols="60"></textarea>`,
    data: {trial_type: "initial_reason", img: stim.stimulus, duration: duration},
    on_finish: function(data){
      data.reason_initial = data.response.reason_initial; // 文字だけ残す
      delete data.response;
    }
  });

  // (5) 詳細判断 + 矩形選択 + スライダー
  timeline.push({
    type: jsPsychHtmlSliderResponse,
    stimulus: function(){
      var last_data = jsPsych.data.get().filter({trial_type: "initial_reason"}).last(1).values()[0];
      var last_reason = last_data?.reason_initial || "";
      return `
        <p>再度画像を提示します。怪しいと思った箇所を四角で選択してください。</p>
        <canvas id="selectionCanvas" style="border:1px solid black;"></canvas>
        <p>理由（編集可）:<br>
          <textarea id="reason_final" rows="5" cols="60">${last_reason}</textarea></p>
      `;
    },
    labels: ["完全に人間", "かなり人間", "やや人間", "不明", "ややAI", "かなりAI", "完全にAI"],
    min: 0, max: 6, start: 3, step: 1,
    require_movement: true,
    slider_width: 800,
    on_load: function(){
      // キャンバスに画像を描画（元のサイズに合わせる）
      var canvas = document.getElementById("selectionCanvas");
      var ctx = canvas.getContext("2d");
      var img = new Image();
      img.src = stim.stimulus;
      img.onload = function(){
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
      };

      // 矩形選択処理
      let startX, startY, isDrawing = false;
      rect = {}; // trialごとの矩形

      canvas.addEventListener("mousedown", function(e){
        isDrawing = true;
        const rectCanvas = canvas.getBoundingClientRect();
        startX = e.clientX - rectCanvas.left;
        startY = e.clientY - rectCanvas.top;
      });

      canvas.addEventListener("mousemove", function(e){
        if(!isDrawing) return;
        const rectCanvas = canvas.getBoundingClientRect();
        const currentX = e.clientX - rectCanvas.left;
        const currentY = e.clientY - rectCanvas.top;

        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img, 0, 0);
        ctx.strokeStyle = "red";
        ctx.lineWidth = 2;
        ctx.strokeRect(startX, startY, currentX - startX, currentY - startY);
      });

      canvas.addEventListener("mouseup", function(e){
        isDrawing = false;
        const rectCanvas = canvas.getBoundingClientRect();
        const endX = e.clientX - rectCanvas.left;
        const endY = e.clientY - rectCanvas.top;

        rect = {
          x: Math.min(startX, endX),
          y: Math.min(startY, endY),
          width: Math.abs(endX - startX),
          height: Math.abs(endY - startY)
        };

        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img, 0, 0);
        ctx.strokeStyle = "red";
        ctx.lineWidth = 2;
        ctx.strokeRect(rect.x, rect.y, rect.width, rect.height);
      });
    },
    on_finish: function(data){
      data.reason_final = document.getElementById("reason_final").value;
      data.rect = rect; // 矩形座標
    },
    data: {trial_type: "final_reason", img: stim.stimulus, duration: duration}
  });

});

// === 実験終了画面 ===
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `<p>実験終了です。ありがとうございました。</p>
             <p><button id="download">データを保存</button></p>`,
  choices: "NO_KEYS",
  on_load: function() {
    document.getElementById('download').addEventListener('click', function() {
      var csv = jsPsych.data.get().csv();
      var blob = new Blob([csv], { type: 'text/csv' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'experiment_data.csv';
      a.click();
      URL.revokeObjectURL(url);
    });
  }
});

// === 実験開始 ===
jsPsych.run(timeline);

</script>
</html>
