<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AI画像識別実験（投げ縄＋PNG保存）</title>

  <!-- jsPsych -->
  <script src="https://unpkg.com/jspsych@7.3.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response"></script>
  <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-slider-response"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form"></script>

  <style>
    .jspsych-html-slider-response-container .jspsych-slider {
      width: 100% !important;
      margin: 0 auto;
    }
    canvas {
      border: 1px solid #444;
      margin-top: 10px;
    }
    .btn {
      padding: 6px 14px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 5px;
      margin-right: 10px;
      cursor: pointer;
    }
  </style>
</head>

<body></body>

<script>

var jsPsych = initJsPsych();
var timeline = [];

// ============================
// 刺激リスト
// ============================
var stimuli = [
  {stimulus: 'stimuli/sample1.png'},
  {stimulus: 'stimuli/sample2.png'}
];


// =====================================
// 各画像ごとに trial を生成
// =====================================
stimuli.forEach(function(stim){

  // (1) 画像を最初から表示＋投げ縄＋理由＋スライダー
  timeline.push({
    type: jsPsychHtmlSliderResponse,

    stimulus: function(){
      return `
        <p>画像を観察し、怪しい箇所を投げ縄で囲ってください。（複数可）</p>

        <canvas id="lassoCanvas"></canvas><br>

        <button class="btn" id="finishLasso">囲み確定</button>
        <button class="btn" id="resetLasso">全消去</button>

        <p>最終判断の理由：</p>
        <textarea id="reason_final" rows="5" cols="60"></textarea>
      `;
    },

    labels: ["完全に人間","かなり人間","やや人間","不明","ややAI","かなりAI","完全にAI"],
    min:0, max:6, start:3, step:1,
    slider_width: 800,
    require_movement: true,

    data: { trial_type:"final_reason", img:stim.stimulus },

    on_load: function(){

      // ---------------------
      // Canvas のセットアップ
      // ---------------------
      const canvas = document.getElementById("lassoCanvas");
      const ctx = canvas.getContext("2d");

      const img = new Image();
      img.src = stim.stimulus;

      // 保存用
      window.lassoList = [];
      let currentLasso = [];
      let drawing = false;

      img.onload = function(){
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0)
